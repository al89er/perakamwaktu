<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>UPM Clock Remote</title>
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1"
    />
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="style.css" />

    <!-- Supabase + config -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
  </head>

  <body>
    <header class="topbar">
      <h1>UPM Clock Remote</h1>
      <p class="subtitle">Control panel for your automated UPM clock-in/out</p>
    </header>

    <main>
      <!-- STATUS CARD AT TOP -->
      <div class="status-card">
        <div id="status-main" class="status-main">Ready</div>
        <div id="status-log" class="status-log"></div>
      </div>

      <!-- TAB CONTENT: CONTROL -->
      <section id="tab-control" class="tab-pane">
        <section class="card">
          <h2>Clock Controls</h2>

          <!-- STATUS BUTTON FIRST -->
          <button class="btn primary" onclick="sendCmd('status')">
            Status
          </button>

          <button class="btn primary" onclick="sendCmd('clockin')">
            Clock IN
          </button>

          <button class="btn primary" onclick="sendCmd('clockout')">
            Clock OUT
          </button>
        </section>

        <section class="card">
          <h2>Skip Controls</h2>

          <button class="btn warning" onclick="sendCmd('skip')">
            Skip Today
          </button>
          <button class="btn warning" onclick="sendCmd('unskip')">
            Unskip Today
          </button>

          <button class="btn warning" onclick="sendCmd('skipnext')">
            Skip Tomorrow
          </button>
          <button class="btn warning" onclick="sendCmd('unskipnext')">
            Unskip Tomorrow
          </button>
        </section>

        <section class="card">
          <h2>System</h2>

          <button class="btn danger" onclick="sendCmd('refresh')">
            Refresh Page
          </button>
          <button class="btn danger" onclick="sendCmd('hardreset')">
            Hard Reset
          </button>
        </section>
      </section>

      <!-- TAB CONTENT: HISTORY -->
      <section id="tab-history" class="tab-pane hidden">
        <section class="card">
          <h2>Response History (last 24h)</h2>
          <div id="history-list" class="history-list"></div>
        </section>
      </section>
    </main>

    <!-- Bottom tab bar -->
    <nav class="tab-bar">
      <button class="tab-button active" data-tab="control">Control</button>
      <button class="tab-button" data-tab="history">History</button>
    </nav>

    <!-- Toast popup -->
    <div id="toast" class="toast"></div>

    <script>
      // Supabase client
      const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const statusMainEl = document.getElementById("status-main");
      const statusLogEl = document.getElementById("status-log");
      const historyListEl = document.getElementById("history-list");
      const toastEl = document.getElementById("toast");
      let toastTimeout = null;

      function setStatusMain(msg) {
        statusMainEl.textContent = msg;
      }

      function appendStatusLog(msg) {
        const row = document.createElement("div");
        row.className = "status-log-item";
        row.textContent =
          new Date().toLocaleTimeString() + " — " + msg;
        statusLogEl.prepend(row); // newest first
      }

      function showToast(msg) {
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        if (toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
          toastEl.classList.remove("show");
        }, 3000);
      }

      async function sendCmd(cmd, args = {}) {
        setStatusMain("Sending: " + cmd + " …");

        const { data, error } = await sb
          .from("commands")
          .insert([{ device_id: DEVICE_ID, cmd, args }])
          .select()
          .single(); // get inserted row

        if (error) {
          console.error(error);
          setStatusMain("❌ Error: " + error.message);
          appendStatusLog("Error sending " + cmd);
          showToast("Error sending " + cmd);
        } else {
          setStatusMain(
            "✔️ Sent: " + cmd + " at " + new Date().toLocaleTimeString()
          );
          appendStatusLog("Command sent: " + cmd);
          // Optionally: show quick toast that it's sent; response will show in realtime
          showToast("Sent: " + cmd);
        }
      }

      // Load history (past 24h)
      async function loadHistory() {
        const sinceIso = new Date(
          Date.now() - 24 * 60 * 60 * 1000
        ).toISOString();

        const { data, error } = await sb
          .from("commands")
          .select("id, cmd, response, created_at, ack_at")
          .eq("device_id", DEVICE_ID)
          .gte("created_at", sinceIso)
          .order("created_at", { ascending: false })
          .limit(50);

        historyListEl.innerHTML = "";

        if (error) {
          console.error(error);
          historyListEl.textContent = "Error loading history.";
          return;
        }

        if (!data || data.length === 0) {
          historyListEl.textContent = "No responses in the last 24 hours.";
          return;
        }

        data.forEach((row) => {
          const item = document.createElement("div");
          item.className = "history-item";

          const cmd = (row.cmd || "").toUpperCase();
          const created = row.created_at
            ? new Date(row.created_at).toLocaleTimeString()
            : "";
          const resp = row.response || "(no response yet)";

          item.innerHTML = `
            <div class="history-top">
              <span class="history-cmd">${cmd}</span>
              <span class="history-time">${created}</span>
            </div>
            <div class="history-response">${resp}</div>
          `;

          historyListEl.appendChild(item);
        });
      }

      // Handle realtime updates from Supabase (command responses)
      function handleUpdateRow(row) {
        if (!row) return;
        const tag = row.cmd ? row.cmd.toUpperCase() : "CMD";

        if (row.response) {
          setStatusMain(row.response);
          appendStatusLog("[" + tag + "] " + row.response);
          showToast(row.response);
          // If user is on history tab, refresh list
          const historyVisible = !document
            .getElementById("tab-history")
            .classList.contains("hidden");
          if (historyVisible) {
            loadHistory();
          }
        } else if (row.ack_at) {
          appendStatusLog("[" + tag + "] acknowledged");
        }
      }

      const channel = sb
        .channel("command_responses_" + DEVICE_ID)
        .on(
          "postgres_changes",
          {
            event: "UPDATE",
            schema: "public",
            table: "commands",
            filter: `device_id=eq.${DEVICE_ID}`,
          },
          (payload) => {
            handleUpdateRow(payload.new);
          }
        )
        .subscribe();

      // One UI–style ripple effect for buttons
      function initRipples() {
        document.querySelectorAll(".btn").forEach((btn) => {
          btn.addEventListener("click", function (e) {
            const rect = this.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const ripple = document.createElement("span");
            ripple.className = "ripple";
            ripple.style.width = ripple.style.height = size + "px";
            ripple.style.left =
              e.clientX - rect.left - size / 2 + "px";
            ripple.style.top =
              e.clientY - rect.top - size / 2 + "px";

            const existing = this.querySelector(".ripple");
            if (existing) existing.remove();
            this.appendChild(ripple);

            setTimeout(() => ripple.remove(), 600);
          });
        });
      }

      // Tabs: Control / History
      function initTabs() {
        const buttons = document.querySelectorAll(".tab-button");
        const tabControl = document.getElementById("tab-control");
        const tabHistory = document.getElementById("tab-history");

        buttons.forEach((btn) => {
          btn.addEventListener("click", () => {
            buttons.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");

            const tab = btn.dataset.tab;
            if (tab === "control") {
              tabControl.classList.remove("hidden");
              tabHistory.classList.add("hidden");
            } else if (tab === "history") {
              tabControl.classList.add("hidden");
              tabHistory.classList.remove("hidden");
              loadHistory();
            }
          });
        });
      }

      // Service worker + init
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js").catch(console.error);
      }

      window.addEventListener("load", () => {
        initRipples();
        initTabs();
        loadHistory(); // preload for when user switches to History tab
      });
    </script>
  </body>
</html>
